<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Malibora Systems">
    
    <title>Malibora Intertrade - Logistics System</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1e40af;
            --bg: #f1f5f9; --white: #ffffff;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --text-dark: #0f172a; --text-light: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 15px; padding-bottom: 90px;
            color: var(--text-dark);
            -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 1200px; margin: 0 auto; display: none; /* Hidden until login */ }

        /* --- LOGIN PAGE STYLES --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; color: white; text-align: center; padding: 20px; box-sizing: border-box;
        }
        .login-box {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 30px; border-radius: 20px;
            width: 100%; max-width: 350px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .login-box h1 { margin: 0 0 5px; font-size: 1.8rem; letter-spacing: 1px; font-weight: 900; }
        .login-box p { margin: 0 0 25px; font-size: 0.9rem; opacity: 0.9; font-weight: 300; }
        
        .pin-input {
            width: 100%; padding: 15px; border-radius: 10px; border: none;
            text-align: center; font-size: 1.5rem; letter-spacing: 5px;
            margin-bottom: 15px; outline: none; background: rgba(255,255,255,0.9); color: #333;
            font-family: 'Roboto', sans-serif;
            box-sizing: border-box; /* Fix for overflow */
        }
        .login-btn {
            width: 100%; padding: 15px; border-radius: 10px; border: none;
            background: #10b981; color: white; font-weight: bold; font-size: 1rem;
            cursor: pointer; transition: 0.2s;
        }
        .login-btn:active { transform: scale(0.98); background: #059669; }
        
        .contact-info {
            margin-top: 30px; font-size: 0.8rem; opacity: 0.8; line-height: 1.6;
        }
        .error-msg { color: #fca5a5; font-size: 0.9rem; margin-top: 10px; min-height: 20px; }

        /* --- APP HEADER & NAV --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--white); padding: 15px 20px; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        .header h1 { margin: 0; font-size: 1.2rem; font-weight: 900; color: var(--primary-dark); }
        
        .lang-btn {
            background: #f1f5f9; border: 1px solid #cbd5e1; padding: 5px 10px;
            border-radius: 8px; font-weight: bold; font-size: 0.8rem; cursor: pointer;
            margin-right: 10px;
        }

        .nav-scroller {
            overflow-x: auto; white-space: nowrap; margin-bottom: 25px;
            padding-bottom: 5px; -webkit-overflow-scrolling: touch;
        }
        .nav-menu { display: inline-flex; gap: 10px; }
        .nav-btn {
            border: none; background: var(--white); padding: 10px 20px;
            border-radius: 50px; font-weight: 500; color: var(--text-light);
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); transition: 0.2s;
            font-family: 'Roboto', sans-serif;
        }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        /* --- DASHBOARD CARDS --- */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px; margin-bottom: 25px;
        }
        .card {
            background: var(--white); padding: 20px; border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; overflow: hidden;
        }
        .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .card.income::before { background: var(--success); }
        .card.expense::before { background: var(--danger); }
        .card.pending::before { background: var(--warning); }
        .card.profit::before { background: var(--primary); }
        
        .card h3 { margin: 0; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 500; }
        .card p { margin: 5px 0 0; font-size: 1.5rem; font-weight: 800; }

        /* --- FORMS & PANELS --- */
        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .panel {
            background: var(--white); padding: 20px; border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 20px;
            overflow-x: auto; /* Allow horizontal scroll for tables on mobile */
        }

        .split-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 10px; font-size: 1rem; background: #f8fafc;
            box-sizing: border-box; margin-bottom: 15px; outline: none;
            font-family: 'Roboto', sans-serif;
        }
        input:focus, select:focus { border-color: var(--primary); background: #fff; }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.85rem; color: var(--text-dark); }

        /* --- RESPONSIVE FORM ROW CLASS --- */
        /* Replaces inline grid styles to fix mobile layout */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 0px; /* Inputs handle their own bottom margin */
        }
        .form-row.three-col {
            grid-template-columns: 1fr 1fr 1fr;
        }

        /* --- BUTTONS --- */
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-weight: 700; cursor: pointer; font-size: 1rem; transition: 0.2s;
            font-family: 'Roboto', sans-serif;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-light); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; display: inline-block; }
        
        .mode-switcher {
            display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin-bottom: 20px;
        }
        .mode-btn {
            flex: 1; padding: 10px; border: none; background: transparent;
            font-weight: 600; color: var(--text-light); border-radius: 10px; cursor: pointer;
            font-family: 'Roboto', sans-serif;
        }
        .mode-btn.active.inc { background: var(--white); color: var(--success); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .mode-btn.active.exp { background: var(--white); color: var(--danger); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .mode-btn.active.debt { background: var(--white); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* --- TABLES --- */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 500px; /* Ensures table doesn't crush on phone */ }
        th { text-align: left; color: var(--text-light); font-size: 0.75rem; padding: 10px 5px; }
        td { padding: 12px 5px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; background: #e2e8f0; color: var(--text-light); }
        .tag.active { background: #dcfce7; color: #166534; }
        .tag.expired { background: #fee2e2; color: #991b1b; }
        .hidden { display: none; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .fuel-badge { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 4px; margin-top: 5px; }
        
        /* New Info Box */
        .info-box { background: #e0f2fe; padding: 15px; border-radius: 12px; border: 1px solid #7dd3fc; margin-bottom: 15px; }
        .info-box p { margin: 0; font-size: 0.9rem; color: #0369a1; }
        .info-box strong { font-size: 1.1rem; display:block; margin-top:4px; }

        /* Debt Info Box */
        .debt-alert { background: #fee2e2; border: 1px solid #fecaca; color: #b91c1c; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: none; animation: fadeIn 0.3s; }

        /* HISTORY PAGE STYLES */
        .history-search { margin-bottom: 20px; }
        .history-card {
            background: white; border-radius: 12px; padding: 15px;
            margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border-left: 4px solid transparent; display: flex;
            justify-content: space-between; align-items: center;
        }
        .history-card.income { border-left-color: var(--success); }
        .history-card.expense { border-left-color: var(--danger); }
        .history-card.debt { border-left-color: var(--primary); }

        .h-date { font-size: 0.75rem; color: #94a3b8; font-weight: 500; }
        .h-title { font-weight: 700; font-size: 1rem; margin: 2px 0; color: #334155; }
        .h-sub { font-size: 0.85rem; color: #64748b; }
        .h-amt { font-weight: 800; font-size: 1rem; }
        .h-status { 
            font-size: 0.7rem; padding: 3px 8px; border-radius: 20px; text-transform: uppercase; font-weight: 700; margin-top: 5px; display: inline-block;
        }
        .st-done { background: #dcfce7; color: #15803d; }
        .st-transit { background: #fef3c7; color: #b45309; }

        /* COMPLIANCE STYLES */
        .comp-header {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            color: white; padding: 25px; border-radius: 16px;
            margin-bottom: 20px; display: flex; align-items: center;
            gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        /* Increased icon container size for the geometric symbol */
        .comp-icon { font-size: 2.5rem; display: flex; align-items: center; justify-content: center; }

        /* MAINTENANCE STYLES */
        .maint-alert-box {
            background: #fefce8; border: 1px solid #fde047; padding: 15px; border-radius: 12px; 
            margin-bottom: 20px; display: none;
        }
        .maint-row { display: flex; align-items: center; justify-content: space-between; color: #854d0e; font-size: 0.9rem; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px dashed #fde047; }
        .maint-row:last-child { border-bottom: none; margin-bottom: 0; }
        .progress-bar-bg { background: #e2e8f0; height: 6px; border-radius: 10px; width: 100%; margin-top: 5px; overflow: hidden;}
        .progress-bar-fill { height: 100%; background: #10b981; transition: width 0.3s; }
        
        /* END TRIP BUTTON */
        .btn-end-trip {
            background-color: #2563eb; color: white; border: none;
            padding: 5px 12px; border-radius: 6px; font-size: 0.75rem;
            font-weight: bold; cursor: pointer; margin-top: 5px;
        }
        .status-badge {
            display: inline-block; padding: 3px 8px; border-radius: 4px;
            font-size: 0.7rem; font-weight: bold; text-transform: uppercase;
        }
        .status-transit { background: #fef3c7; color: #b45309; }
        .status-complete { background: #dcfce7; color: #15803d; }

        /* ROUTE BUILDER */
        .route-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .route-row select { margin-bottom: 0; flex: 2; }
        .route-row input { margin-bottom: 0; flex: 1; }
        .btn-add-stop { background: #e2e8f0; color: #334155; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        /* MAP STYLES */
        #map {
            height: 500px; width: 100%; border-radius: 16px;
            z-index: 1; margin-bottom: 10px; border: 2px solid #e2e8f0;
        }
        .map-item-card {
            background: #fff; padding: 10px; margin-bottom: 5px;
            border-radius: 8px; border-left: 4px solid #ccc;
            cursor: pointer; font-size: 0.85rem;
        }
        .map-item-card:hover { background: #f8fafc; }

        /* --- MOBILE MEDIA QUERIES --- */
        @media (max-width: 768px) {
            .split-layout { grid-template-columns: 1fr; } 
            
            /* Force stacked inputs on mobile */
            .form-row, .form-row.three-col {
                grid-template-columns: 1fr !important;
                gap: 5px;
            }
            
            .header { flex-direction: column; text-align: center; gap: 10px; }
            .header > div { width: 100%; justify-content: center; }
            
            #map { height: 350px; } /* Smaller map on mobile */
            
            .container { padding: 10px; padding-bottom: 80px; }
            .nav-btn { padding: 8px 12px; font-size: 0.9rem; }
            
            .login-box { padding: 20px; }
            
            /* Adjust Manage sections to stack */
            .manage-inputs { flex-direction: column !important; }
            .manage-inputs input, .manage-inputs select { width: 100%; flex: none !important; margin-bottom: 5px !important; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h1>MALIBORA</h1>
        <p>International Logistics Truck Management System (ILTM)</p>
        
        <input type="password" id="pinInput" class="pin-input" placeholder="****" maxlength="4">
        <div class="error-msg" id="loginError"></div>
        <button class="login-btn" onclick="attemptLogin()">LOGIN</button>

        <div class="contact-info">
            <p><strong>Information/Need Help? Contact Support:</strong><br>
            üìû +255 753 453 518<br>
            üìß malibora.tanzania@gmail.com<br>
            üìç Dar es Salaam, Tanzania</p>
        </div>
    </div>
    <div style="position: absolute; bottom: 10px; font-size: 0.7rem; opacity: 0.5;">
        System v8.4 | Compliance Symbol Updated
    </div>
</div>

<div class="container" id="app-container">
    <div class="header">
        <div>
            <h1 style="margin:0;">International Logistics Truck Management System (ILTM)</h1>
            <small style="color:#64748b;">TruckTracker Pro v8.4</small>
        </div>
        <div style="display:flex; align-items:center;">
            <button class="lang-btn" onclick="toggleLanguage()" id="btnLang">üáπüáø SW</button>
            <button onclick="exportData()" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;">üì•</button>
            <button onclick="logout()" style="background:none; border:none; font-size: 1.2rem; cursor:pointer; margin-left:10px;">üîí</button>
        </div>
    </div>

    <div class="nav-scroller">
        <div class="nav-menu">
            <button class="nav-btn active" onclick="nav('dashboard')" data-key="nav_dash">Dashboard</button>
            <button class="nav-btn" onclick="nav('map-section')" data-key="nav_map">üó∫Ô∏è Live Map</button>
            <button class="nav-btn" onclick="nav('history')" data-key="nav_hist">üìú History</button>
            <button class="nav-btn" onclick="nav('analytics')" data-key="nav_analytics">üìä Analytics</button>
            <button class="nav-btn" onclick="nav('debt')" data-key="nav_debt">üí∞ Collect Debt</button>
            <button class="nav-btn" onclick="nav('operations')" data-key="nav_ops">OPERATIONS</button>
            <button class="nav-btn" onclick="nav('compliance')" data-key="nav_comp">üõ°Ô∏è Compliance</button>
            <button class="nav-btn" onclick="nav('settings')" data-key="nav_set">Settings</button>
        </div>
    </div>

    <div id="dashboard" class="section active">
        <div id="maint-alert-box" class="maint-alert-box">
            <h3 style="margin:0 0 10px; color:#a16207;">‚ö†Ô∏è Maintenance Required</h3>
            <div id="maint-list"></div>
        </div>

        <div class="kpi-grid">
            <div class="card income">
                <h3 data-key="kpi_cash">Cash In Hand</h3>
                <p id="kpi-cash" class="text-success">0</p>
            </div>
            <div class="card pending">
                <h3 data-key="kpi_debt">Pending Debt</h3>
                <p id="kpi-pending" style="color: var(--warning)">0</p>
            </div>
            <div class="card expense">
                <h3 data-key="kpi_exp">Expenses</h3>
                <p id="kpi-expense" class="text-danger">0</p>
            </div>
            <div class="card profit">
                <h3 data-key="kpi_profit">Net Profit</h3>
                <p id="kpi-profit">0</p>
            </div>
        </div>

        <div class="panel">
            <h3 data-key="fleet_perf">üöõ Fleet Performance & Maintenance</h3>
            <div style="background:#f0fdf4; border:1px solid #bbf7d0; padding:10px; border-radius:8px; margin-bottom:15px; display:flex; align-items:center; gap:10px; flex-wrap: wrap;">
                <span style="font-size:0.8rem; font-weight:bold; color:#166534;">Quick Service Action:</span>
                <select id="quickServiceTruck" style="margin:0; font-size:0.8rem; padding:5px; flex: 1;">
                    <option value="">Select Truck...</option>
                </select>
                <button onclick="manualServiceReset()" class="btn-sm" style="background:#166534; color:white; border:none; border-radius:4px; cursor:pointer;">Mark Service Done</button>
            </div>

            <div style="overflow-x:auto;">
                <table id="fuelTable">
                    <thead>
                        <tr>
                            <th data-key="th_truck">Truck</th>
                            <th style="color:var(--primary)" data-key="th_profit_short">Profit</th>
                            <th data-key="th_eco">Eco (Km/L)</th>
                            <th>Service Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="fuelList"></tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <h3>‚õΩ Fuel Analysis & Analytics</h3>
            <div class="kpi-grid" style="margin-bottom:15px;">
                <div class="card" style="background:#fff7ed; border:1px solid #ffedd5;">
                    <h3 style="color:#c2410c">Total Fuel Used</h3>
                    <p style="color:#9a3412" id="total-fuel-liters">0 L</p>
                </div>
                <div class="card" style="background:#fff7ed; border:1px solid #ffedd5;">
                    <h3 style="color:#c2410c">Total Fuel Cost</h3>
                    <p style="color:#9a3412" id="total-fuel-cost">0 TZS</p>
                </div>
            </div>
            
            <div style="overflow-x:auto;">
                <table id="fuelAnalyticsTable">
                    <thead>
                        <tr>
                            <th>Truck</th>
                            <th>Fuel Used (L)</th>
                            <th>Fuel Cost (TZS)</th>
                            <th>% of Total</th>
                        </tr>
                    </thead>
                    <tbody id="fuelAnalyticsList"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="map-section" class="section">
        <div class="split-layout">
            <div class="panel" style="flex:2;">
                <h3 style="margin-top:0;">üó∫Ô∏è Active Fleet Routes</h3>
                <p style="font-size:0.9rem; color:#64748b; margin-bottom:15px;">Visualizing assigned routes for trucks currently 'In Transit'.</p>
                <div id="map"></div>
                <div id="active-routes-legend" style="font-size:0.8rem; color:#64748b; margin-top:5px;">
                    <span style="display:inline-block; margin-right:10px;">üü¢ Origin</span>
                    <span style="display:inline-block; margin-right:10px;">üèÅ Destination</span>
                    <span style="display:inline-block;">üöö Truck En Route</span>
                </div>
            </div>
            
            <div class="panel" style="flex:1; max-height:600px; overflow-y:auto;">
                <h3>Active Trucks</h3>
                <div id="activeTrucksList"></div>
            </div>
        </div>
    </div>

    <div id="history" class="section">
        <div class="panel">
            <h3 style="margin-top:0;">üìú Operations History</h3>
            <input type="text" id="histSearch" class="history-search" placeholder="Search Driver, Truck, or Customer..." onkeyup="renderHistory()">
            <div id="historyList"></div>
        </div>
    </div>

    <div id="analytics" class="section">
        <div class="panel">
            <h3 data-key="chart_income">Income vs Expense (This Year)</h3>
            <canvas id="chartProfit" style="max-height: 250px;"></canvas>
        </div>
        <div class="panel">
            <h3 data-key="chart_breakdown">Expense Breakdown</h3>
            <canvas id="chartExpense" style="max-height: 250px;"></canvas>
        </div>
    </div>

    <div id="debt" class="section">
        <div class="panel" style="background: #fffbeb; border: 1px solid #fcd34d;">
            <h3 data-key="nav_debt">Collect Debt Payment</h3>
            <p style="margin:0 0 15px; font-size: 0.9rem; color: #b45309;" data-key="debt_desc">Receive payment for past debt.</p>

            <label data-key="lbl_date">Date</label>
            <input type="date" id="debtDate">

            <label data-key="lbl_cust">Customer</label>
            <select id="debtCustomer" onchange="checkCustomerDebt()"></select>

            <div id="debtDisplay" class="debt-alert">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>Outstanding Debt:</span>
                    <strong style="font-size:1.2rem;" id="currentDebtVal">0</strong>
                </div>
            </div>

            <div id="paymentModeDiv" class="hidden" style="margin-bottom:15px;">
                <label>Payment Options</label>
                <div class="form-row">
                    <button class="btn btn-outline" id="btnFull" onclick="setDebtType('full')" style="border-color:var(--success); color:var(--success);">üî¥ Full Payment</button>
                    <button class="btn btn-outline" id="btnPartial" onclick="setDebtType('partial')" style="border-color:var(--warning); color:#b45309;">üü° Partial / Half</button>
                </div>
            </div>

            <label data-key="lbl_amt_rec">Amount Received</label>
            <input type="number" id="debtAmount" placeholder="Amount Paid">

            <label data-key="lbl_desc">Description</label>
            <textarea id="debtDesc" rows="2"></textarea>

            <label data-key="lbl_method">Payment Method</label>
            <select id="debtMethod" onchange="toggleDebtBank()">
                <option value="Cash">Cash</option>
                <option value="Bank">Bank</option>
                <option value="Mobile">Mobile</option>
            </select>

            <div id="debt-bank-select" class="hidden">
                <label data-key="lbl_bank">Select Bank</label>
                <select id="debtBank">
                    <option value="">Select Bank...</option>
                    <option>CRDB Bank</option>
                    <option>NMB Bank</option>
                    <option>NBC Bank</option>
                    <option>Stanbic Bank</option>
                    <option>Absa Bank</option>
                    <option>Exim Bank</option>
                    <option>DTB</option>
                    <option>Azania Bank</option>
                    <option>KCB Bank</option>
                    <option>Equity Bank</option>
                    <option>TCB (Postal)</option>
                    <option>PBZ</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="saveDebtTx()" data-key="btn_save_debt">SAVE PAYMENT</button>
        </div>
    </div>

    <div id="operations" class="section">
        <div class="split-layout">
            <div class="panel">
                <div class="mode-switcher">
                    <button class="mode-btn active inc" onclick="setMode('income')" data-key="mode_trip">Trip</button>
                    <button class="mode-btn exp" onclick="setMode('expense')" data-key="mode_exp">Expense</button>
                </div>
                <input type="hidden" id="opMode" value="income">

                <div class="form-row">
                    <div><label data-key="lbl_date">Date</label><input type="date" id="opDate" onchange="checkDriverAvailability()"></div>
                    <div id="field-truck"><label data-key="lbl_truck">Truck</label><select id="opTruck" onchange="calcEstFuel()"></select></div>
                </div>
                
                <div id="field-driver" class="form-group">
                    <label data-key="lbl_driver">Driver (Auto-selects Truck)</label>
                    <select id="opDriver" onchange="autoFillDriverDetails()"></select>
                </div>

                <div id="grp-income">
                    <div style="border: 1px solid #cbd5e1; padding:15px; border-radius:10px; margin-bottom:15px; background:#f8fafc;">
                        <h4 style="margin-top:0; color:var(--primary);">üó∫Ô∏è Trip Details</h4>
                        
                        <div class="form-row" style="margin-top:10px;">
                            <div>
                                <label>Type</label>
                                <select id="opTripType" onchange="updateTripUI(); calcEstFuel()">
                                    <option value="Single">Single Trip</option>
                                    <option value="Round">Round Trip (Multi-Stop)</option>
                                </select>
                            </div>
                            <div>
                                <label>Load Status</label>
                                <select id="opLoadStatus" onchange="checkCargo(); calcEstFuel()">
                                    <option value="Loaded">Loaded</option>
                                    <option value="Empty">Empty</option>
                                </select>
                            </div>
                        </div>

                        <div id="singleTripUI" class="form-row" style="margin-top:10px;">
                            <div><label>From</label><select id="opFrom"></select></div>
                            <div><label>To</label><select id="opTo"></select></div>
                        </div>

                        <div id="multiStopUI" class="hidden" style="margin-top:10px;">
                            <label>Route Stops & Distances</label>
                            <div id="routeRows"></div>
                            <button onclick="addRouteLeg()" class="btn-add-stop">+ Add Stop</button>
                        </div>

                        <div id="divCargo" style="margin-top:10px;">
                            <label>üì¶ Cargo Type</label>
                            <input type="text" id="opCargoType" placeholder="e.g. Maize, Cement, Copper">
                        </div>

                        <label style="margin-top:10px;" data-key="lbl_dist">Total Distance (Km)</label>
                        <input type="number" id="opDist" placeholder="Calculated automatically..." oninput="calcEstFuel()">

                        <div class="info-box">
                            <p>‚õΩ Smart Fuel Estimate (Tanzania)</p>
                            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                                <strong id="estLiters">0 Liters</strong>
                                <strong id="estCost">0 TZS</strong>
                            </div>
                            <small id="estInfo" style="display:block; margin-top:5px; color:#64748b; font-size:0.75rem;"></small>
                        </div>
                    </div>

                    <label data-key="lbl_cust">Customer (Auto-Filled)</label><select id="opCustomer"></select>
                    
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; border: 1px solid #bae6fd; margin-bottom: 15px;">
                        <div class="form-row">
                            <div><label data-key="lbl_total">Total Price</label><input type="number" id="opTotal" oninput="calcBal()"></div>
                            <div><label data-key="lbl_paid">Paid Now</label><input type="number" id="opPaid" oninput="calcBal()"></div>
                        </div>
                        <div style="text-align: right; font-weight: bold; color: var(--primary);">
                            <span data-key="lbl_bal">Balance</span>: <span id="lblBal">0</span>
                        </div>
                    </div>
                </div>

                <div id="grp-expense" class="hidden">
                    <label data-key="lbl_cat">Category</label><select id="opCat" onchange="checkFuel()"></select>
                    
                    <div id="grp-fuel" class="hidden" style="background: #fff7ed; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <label data-key="lbl_liters">Fuel Liters</label>
                        <input type="number" id="opLiters" placeholder="Liters filled" oninput="calcFuelCost()">
                        <div style="text-align:right; font-size:0.8rem; color:#ea580c;">Current Price: ~3,430 TZS/L</div>
                    </div>

                    <label data-key="lbl_amt">Amount</label><input type="number" id="opExpAmount">
                </div>

                <label data-key="lbl_desc">Description</label><textarea id="opDesc" rows="2"></textarea>

                <label data-key="lbl_method">Payment Method</label>
                <select id="opMethod" onchange="toggleBank()">
                    <option value="Cash">Cash</option>
                    <option value="Bank">Bank</option>
                    <option value="Mobile">Mobile</option>
                </select>

                <div id="bank-select" class="hidden">
                    <label data-key="lbl_bank">Select Bank</label>
                    <select id="opBank">
                        <option value="">Select Bank...</option>
                        <option>CRDB Bank</option>
                        <option>NMB Bank</option>
                        <option>NBC Bank</option>
                        <option>Stanbic Bank</option>
                        <option>Absa Bank</option>
                        <option>Exim Bank</option>
                        <option>DTB</option>
                        <option>Azania Bank</option>
                        <option>KCB Bank</option>
                        <option>Equity Bank</option>
                        <option>TCB (Postal)</option>
                        <option>PBZ</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="saveOp()" data-key="btn_save">SAVE TRANSACTION</button>
            </div>

            <div class="panel">
                <h3 data-key="recent_act">Recent Activity (Editable)</h3>
                <div id="txList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <div id="compliance" class="section">
        <div class="comp-header">
            <div class="comp-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/>
                    <path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/>
                    <path d="M7 21h10"/>
                    <path d="M12 3v18"/>
                    <path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/>
                </svg>
            </div>
            <div>
                <h2 style="margin:0; font-size:1.4rem;">Regulatory & Compliance</h2>
                <small style="opacity:0.8;">Manage LATRA, Insurance, Parking & Penalties</small>
            </div>
        </div>

        <div class="panel">
            <h3 data-key="nav_comp">Add New Record</h3>
            <div class="form-row" style="margin-bottom:10px;">
                <div style="grid-column: span 2;">
                    <label>Regulatory Category (Tanzania)</label>
                    <select id="cpType">
                        </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Truck / Vehicle</label>
                    <select id="cpTruck"></select>
                </div>
                <div>
                    <label>Expiry / Due Date</label>
                    <input type="date" id="cpDate">
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Amount (TZS)</label>
                    <input type="number" id="cpAmount" placeholder="Cost">
                </div>
                 <div>
                    <label>Ref / Receipt No</label>
                    <input type="text" id="cpRef" placeholder="Control #">
                </div>
            </div>
            <button class="btn btn-primary" onclick="addCompliance()" data-key="btn_add">Add Compliance Record</button>
        </div>
        
        <div class="panel">
            <h3>üìú Compliance Status</h3>
            <div style="overflow-x:auto;">
                <table id="cpTable">
                    <thead><tr><th data-key="th_item">Item / Permit</th><th>Truck</th><th data-key="th_due">Expiry Date</th><th data-key="th_status">Status</th><th data-key="th_action">Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="settings" class="section">
        <div class="panel">
            <h3 data-key="set_backup">üíæ Data Backup</h3>
            <div class="form-row">
                <button class="btn btn-primary" onclick="backupData()" data-key="btn_dl">Download Backup</button>
                <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()" data-key="btn_restore">Restore File</button>
            </div>
            <input type="file" id="fileInput" class="hidden" onchange="restoreData(this)">
        </div>

        <div class="split-layout">
            <div class="panel">
                <h3 data-key="mng_trucks">Manage Trucks</h3>
                <div class="manage-inputs" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;">
                    <input id="newTruckPlate" placeholder="Plate No." style="margin:0; flex:1;">
                    <select id="newTruckModel" style="margin:0; flex:1;">
                        <option value="Scania">Scania</option>
                        <option value="Howo">Howo</option>
                        <option value="Fuso">Fuso</option>
                        <option value="Renault">Renault</option>
                        <option value="Mercedes">Mercedes</option>
                        <option value="Canter">Canter</option>
                    </select>
                    <select id="newTruckTrailers" style="margin:0; flex:0 0 100px;">
                        <option value="0">0 Trailers</option>
                        <option value="1">1 Trailer</option>
                        <option value="2">2 Trailers</option>
                    </select>
                    <input id="newTruckInterval" type="number" placeholder="Service Interval (km)" style="margin:0; flex:1; min-width:150px;">
                </div>
                <button class="btn btn-primary" style="margin-bottom:10px;" onclick="addTruck()" data-key="btn_add_truck">Add Truck</button>
                <div id="lst-trucks"></div>
            </div>

            <div class="panel">
                <h3 data-key="mng_drivers">Manage Drivers & Assignments</h3>
                <div class="manage-inputs" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:5px;">
                    <input id="newDriver" placeholder="Driver Name" style="margin:0; flex:1;">
                    <select id="newDriverCust" style="margin:0; flex:1;">
                        <option value="">Assign Customer...</option>
                    </select>
                    
                    <div style="flex:1;">
                        <select id="newDriverTruck" style="margin:0; width:100%;" onchange="checkTruckAssignment(this)">
                            <option value="">Assign Truck...</option>
                        </select>
                        <small id="truck-assign-error" style="color:var(--danger); display:none; font-weight:bold;">‚ö†Ô∏è Truck already assigned!</small>
                    </div>
                </div>
                <button class="btn btn-primary" style="margin-bottom:10px;" onclick="addDriver()" data-key="btn_add">Add Driver</button>
                <div id="lst-drivers"></div>
            </div>
        </div>

        <div class="split-layout" style="margin-top:20px;">
            <div class="panel">
                <h3 data-key="mng_cust">Manage Customers</h3>
                <div style="display:flex; gap:5px;"><input id="newCust" placeholder="Customer Name"><button class="btn btn-primary" style="width:auto;" onclick="addReg('customers','newCust')">+</button></div>
                <div id="lst-customers"></div>
            </div>
            
            <div class="panel">
                <h3 data-key="mng_cat">Expense Categories</h3>
                <div style="display:flex; gap:5px;"><input id="newCat" placeholder="New Category"><button class="btn btn-primary" style="width:auto;" onclick="addReg('categories','newCat')">+</button></div>
                <div id="lst-categories" style="max-height: 200px; overflow-y:auto;"></div>
            </div>
        </div>
        
        <div class="panel" style="background:#fef2f2; border:1px solid #fca5a5; margin-top:20px;">
            <h3 class="text-danger" data-key="danger_zone">Danger Zone</h3>
            <button class="btn btn-outline" style="color:var(--danger); border-color:var(--danger);" onclick="wipeData()" data-key="factory_reset">Factory Reset App</button>
        </div>
    </div>

</div>

<script>
    // --- CONSTANTS ---
    const FUEL_PRICE_TZ = 3430; 
    
    // Updated: Regions with Coordinates for Mapping
    const REGION_COORDS = {
        "Arusha": [-3.3667, 36.6833],
        "Dar es Salaam": [-6.8235, 39.2695],
        "Dodoma": [-6.1630, 35.7516],
        "Geita": [-2.8694, 32.2330],
        "Iringa": [-7.7667, 35.7000],
        "Kagera": [-1.3292, 31.8126],
        "Katavi": [-6.3667, 31.1333],
        "Kigoma": [-4.8769, 29.6267],
        "Kilimanjaro": [-3.3500, 37.3333],
        "Lindi": [-9.9969, 39.7145],
        "Manyara": [-4.2167, 35.7500],
        "Mara": [-1.5000, 33.8000],
        "Mbeya": [-8.9000, 33.4500],
        "Morogoro": [-6.8278, 37.6611],
        "Mtwara": [-10.2736, 40.1828],
        "Mwanza": [-2.5167, 32.9000],
        "Njombe": [-9.3333, 34.7667],
        "Pemba North": [-5.0333, 39.7833],
        "Pemba South": [-5.3500, 39.7667],
        "Pwani": [-6.7667, 38.9167],
        "Rukwa": [-7.9667, 31.6167],
        "Ruvuma": [-10.6833, 35.6500],
        "Shinyanga": [-3.6667, 33.4333],
        "Simiyu": [-2.8000, 33.9833],
        "Singida": [-4.8167, 34.7500],
        "Songwe": [-9.1167, 32.9333],
        "Tabora": [-5.0167, 32.8000],
        "Tanga": [-5.0667, 39.0983],
        "Unguja North": [-5.9333, 39.2833],
        "Unguja South": [-6.2667, 39.4333],
        "Mjini Magharibi": [-6.1600, 39.2000]
    };
    
    const REGIONS_TZ = Object.keys(REGION_COORDS);

    const COMPLIANCE_TYPES_TZ = [
        "LATRA - Goods Carrying License",
        "TRA - Road License (Annual)",
        "Insurance - Comprehensive",
        "Vehicle Inspection (Kagua)",
        "Fire & Rescue Permit (Zimamoto)",
        "Parking - City Council (Jiji)",
        "Parking - Municipal (Manispaa)",
        "Parking - Town Council (Mji)",
        "Parking - District (Wilaya)",
        "Traffic Fine (Notification)",
        "Overloading Penalty (Mizani)",
        "City Service Levy",
        "OSHA Compliance"
    ];

    // --- LANGUAGE DATA ---
    const i18n = {
        en: {
            nav_dash: "Dashboard", nav_map: "üó∫Ô∏è Live Map", nav_hist: "History", nav_analytics: "Analytics", nav_debt: "Collect Debt", nav_ops: "Operations", nav_comp: "Compliance", nav_set: "Settings",
            kpi_cash: "Cash In Hand", kpi_debt: "Pending Debt", kpi_exp: "Expenses", kpi_profit: "Net Profit",
            fleet_perf: "üöõ Fleet Performance & Maintenance", 
            th_truck: "Truck", th_fuel: "Fuel Used", th_km: "Km Covered", th_eco: "Economy (Km/L)",
            th_exp: "Expenses", th_profit_short: "Profit",
            chart_income: "Income vs Expense (This Year)", chart_breakdown: "Expense Breakdown",
            mode_trip: "Trip", mode_exp: "Expense",
            lbl_date: "Date", lbl_truck: "Truck", lbl_driver: "Driver",
            lbl_cust: "Customer", lbl_dist: "Total Distance (Km)", lbl_total: "Total Price", lbl_paid: "Paid Now", lbl_bal: "Balance",
            debt_desc: "Receive payment for past debt.", lbl_amt_rec: "Amount Received", btn_save_debt: "SAVE PAYMENT",
            lbl_cat: "Category", lbl_liters: "Fuel Liters", lbl_amt: "Amount", lbl_desc: "Description", lbl_method: "Payment Method", lbl_bank: "Select Bank",
            btn_save: "SAVE TRANSACTION", recent_act: "Recent Activity (Editable)",
            th_item: "Item", th_due: "Due Date", th_status: "Status", th_action: "Action", btn_add: "Add Record",
            set_backup: "üíæ Data Backup", btn_dl: "Download Backup", btn_restore: "Restore File",
            mng_trucks: "Manage Trucks", btn_add_truck: "Add Truck", mng_drivers: "Manage Drivers", mng_cust: "Manage Customers", mng_cat: "Expense Categories",
            danger_zone: "Danger Zone", factory_reset: "Factory Reset App"
        },
        sw: {
            nav_dash: "Dashibodi", nav_map: "üó∫Ô∏è Ramani", nav_hist: "Historia", nav_analytics: "Uchambuzi", nav_debt: "Kusanya Deni", nav_ops: "Rekodi", nav_comp: "Sheria", nav_set: "Mipangilio",
            kpi_cash: "Pesa Mkononi", kpi_debt: "Madeni", kpi_exp: "Matumizi", kpi_profit: "Faida Halisi",
            fleet_perf: "üöõ Utendaji wa Malori & Matengenezo", 
            th_truck: "Lori", th_fuel: "Mafuta", th_km: "Km", th_eco: "Matumizi (Km/L)",
            th_exp: "Matumizi", th_profit_short: "Faida",
            chart_income: "Mapato vs Matumizi (Mwaka huu)", chart_breakdown: "Mchanganuo wa Matumizi",
            mode_trip: "Safari", mode_exp: "Matumizi",
            lbl_date: "Tarehe", lbl_truck: "Lori", lbl_driver: "Dereva",
            lbl_cust: "Mteja", lbl_dist: "Umbali Jumla (Km)", lbl_total: "Bei Jumla", lbl_paid: "imelipwa", lbl_bal: "Deni",
            debt_desc: "Pokea malipo ya deni la nyuma.", lbl_amt_rec: "Kiasi Kilichopokelewa", btn_save_debt: "HIFADHI MALIPO",
            lbl_cat: "Aina", lbl_liters: "Lita za Mafuta", lbl_amt: "Kiasi", lbl_desc: "Maelezo", lbl_method: "Njia ya Malipo", lbl_bank: "Chagua Benki",
            btn_save: "HIFADHI TAARIFA", recent_act: "Shughuli za Hivi Karibuni",
            th_item: "Kitu", th_due: "Tarehe ya Mwisho", th_status: "Hali", th_action: "Hatua", btn_add: "Ongeza",
            set_backup: "üíæ Hifadhi Data", btn_dl: "Pakua Backup", btn_restore: "Rudisha Data",
            mng_trucks: "Simamia Malori", btn_add_truck: "Ongeza Lori", mng_drivers: "Madereva", mng_cust: "Wateja", mng_cat: "Aina za Matumizi",
            danger_zone: "Eneo la Hatari", factory_reset: "Futa Kila Kitu"
        }
    };

    let curLang = localStorage.getItem('truck_lang') || 'en';

    function toggleLanguage() {
        curLang = curLang === 'en' ? 'sw' : 'en';
        localStorage.setItem('truck_lang', curLang);
        applyLanguage();
    }

    function applyLanguage() {
        document.getElementById('btnLang').innerText = curLang === 'en' ? "üáπüáø SW" : "üá∫üá∏ EN";
        document.querySelectorAll('[data-key]').forEach(el => {
            const k = el.getAttribute('data-key');
            if(i18n[curLang][k]) el.innerText = i18n[curLang][k];
        });
        renderCharts(); 
    }

    // --- LOGIN LOGIC ---
    function attemptLogin() {
        const pin = document.getElementById('pinInput').value;
        const correctPin = localStorage.getItem('malibora_pin') || '1234';
        
        if (pin === correctPin) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            renderCharts(); 
            initMap(); // Initialize map on login
        } else {
            document.getElementById('loginError').innerText = "Incorrect PIN";
            setTimeout(() => document.getElementById('loginError').innerText = "", 2000);
        }
    }

    function logout() {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
        document.getElementById('pinInput').value = '';
    }

    // --- STATE MANAGEMENT ---
    const DB_KEY = 'truck_v55_db';
    
    const tzExpenses = [
        "Fuel", "Driver Allowance", "Turnboy Allowance", "Road License", "Insurance", "LATRA Fee", 
        "Traffic Fine", "Parking", "Gate Fee", "Loading (Vibarua)", "Unloading", "Weighbridge (Mizani)",
        "Dalali (Broker)", "Tyres", "Spare Parts", "Mechanic Labor", "Oil Change", "Grease/Lubricants",
        "Battery", "Welding", "Car Wash", "Air Cleaner", "Leaf Springs", "Clutch", "Brake Pads",
        "Council Levy", "Tiff", "Yard Fee", "Accommodation (Malazi)", "Airtime/Bundle", "Office Rent",
        "Electricity", "Water", "Salaries (Office)", "Consultancy", "Permit", "Border Crossing Fee",
        "Ferry Fee", "Escort Fee", "Miscellaneous"
    ];

    let db = {
        trucks: [], 
        drivers: [],
        customers: [], 
        categories: tzExpenses,
        txs: [], 
        compliance: []
    };

    // --- INIT ---
    function init() {
        const saved = localStorage.getItem(DB_KEY);
        if(saved) {
            try {
                let temp = JSON.parse(saved);
                if(!temp.drivers) temp.drivers = [];
                if(!temp.compliance) temp.compliance = [];
                if(!temp.txs) temp.txs = [];
                if(!temp.trucks) temp.trucks = [];
                if(!temp.customers) temp.customers = [];
                if(!temp.categories || temp.categories.length < 10) temp.categories = tzExpenses;
                db = temp;
                
                db.trucks.forEach(t => {
                    if (typeof t === 'object') {
                        if(t.odo === undefined) t.odo = 0;
                        if(t.interval === undefined) t.interval = 5000;
                        if(t.lastServiceOdo === undefined) t.lastServiceOdo = 0;
                    }
                });

            } catch(e) {
                console.error("Migration error:", e);
            }
        }

        document.getElementById('opDate').valueAsDate = new Date();
        const dDate = document.getElementById('debtDate');
        if(dDate) dDate.valueAsDate = new Date();
        document.getElementById('cpDate').valueAsDate = new Date();
        
        fillRegions();
        checkCargo(); // Initial check
        applyLanguage(); 
        renderAll();
        addRouteLeg(); // Add initial leg for route builder
        addRouteLeg(); // Add second leg
    }

    // --- NAVIGATION ---
    function nav(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if(id === 'analytics') renderCharts();
        if(id === 'history') renderHistory();
        
        // --- MAP TAB FIX ---
        if(id === 'map-section') {
            setTimeout(() => {
                if(map) {
                    map.invalidateSize(); // Force map to redraw size
                    updateMap(); // Re-plot points
                } else {
                    initMap();
                }
            }, 100);
        }
    }

    function setMode(mode) {
        document.getElementById('opMode').value = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.mode-btn.${mode === 'income' ? 'inc' : 'exp'}`).classList.add('active');

        document.getElementById('grp-income').classList.add('hidden');
        document.getElementById('grp-expense').classList.add('hidden');
        
        if(mode === 'income') document.getElementById('grp-income').classList.remove('hidden');
        else if(mode === 'expense') document.getElementById('grp-expense').classList.remove('hidden');
    }

    function checkFuel() {
        const cat = document.getElementById('opCat').value;
        document.getElementById('grp-fuel').classList.toggle('hidden', cat !== 'Fuel');
    }

    function toggleBank() {
        const method = document.getElementById('opMethod').value;
        document.getElementById('bank-select').classList.toggle('hidden', method !== 'Bank');
    }

    function toggleDebtBank() {
        const method = document.getElementById('debtMethod').value;
        document.getElementById('debt-bank-select').classList.toggle('hidden', method !== 'Bank');
    }

    function fillRegions() {
        const opts = REGIONS_TZ.map(r => `<option value="${r}">${r}</option>`).join('');
        document.getElementById('opFrom').innerHTML = `<option value="">Select Region...</option>` + opts;
        document.getElementById('opTo').innerHTML = `<option value="">Select Region...</option>` + opts;
        window.regionOpts = `<option value="">Select Region...</option>` + opts;
    }

    function checkCargo() {
        const status = document.getElementById('opLoadStatus').value;
        const cargoDiv = document.getElementById('divCargo');
        if (status === 'Empty') {
            cargoDiv.style.display = 'none';
            document.getElementById('opCargoType').value = ''; 
        } else {
            cargoDiv.style.display = 'block';
        }
    }

    // --- ROUND TRIP ROUTE LOGIC ---
    function updateTripUI() {
        const type = document.getElementById('opTripType').value;
        if(type === 'Round') {
            document.getElementById('singleTripUI').classList.add('hidden');
            document.getElementById('multiStopUI').classList.remove('hidden');
            document.getElementById('opDist').placeholder = "Sum of route legs (Auto)";
            document.getElementById('opDist').readOnly = true; 
        } else {
            document.getElementById('singleTripUI').classList.remove('hidden');
            document.getElementById('multiStopUI').classList.add('hidden');
            document.getElementById('opDist').placeholder = "e.g. 600";
            document.getElementById('opDist').readOnly = false;
        }
        calcRouteDist();
    }

    function addRouteLeg() {
        const div = document.createElement('div');
        div.className = 'route-row';
        div.innerHTML = `
            <select class="route-region" onchange="calcRouteDist()">${window.regionOpts}</select>
            <input type="number" class="route-km" placeholder="Km to here" oninput="calcRouteDist()">
            <span style="color:red; cursor:pointer; padding:5px;" onclick="this.parentElement.remove(); calcRouteDist()">√ó</span>
        `;
        document.getElementById('routeRows').appendChild(div);
    }

    function calcRouteDist() {
        const type = document.getElementById('opTripType').value;
        if (type === 'Round') {
            let total = 0;
            document.querySelectorAll('.route-km').forEach(inp => {
                total += (parseFloat(inp.value) || 0);
            });
            document.getElementById('opDist').value = total > 0 ? total : '';
            calcEstFuel(); // trigger fuel calc based on new total
        }
    }

    // --- DEBT LOGIC ---
    let currentCustomerDebt = 0;

    function checkCustomerDebt() {
        const cust = document.getElementById('debtCustomer').value;
        const debtDisp = document.getElementById('debtDisplay');
        const payDiv = document.getElementById('paymentModeDiv');
        const amtInput = document.getElementById('debtAmount');
        const descInput = document.getElementById('debtDesc');

        if (!cust) {
            debtDisp.style.display = 'none';
            payDiv.classList.add('hidden');
            amtInput.value = '';
            return;
        }

        // Calculate Debt
        let totalDebt = 0;
        db.txs.forEach(t => {
            if (t.customer === cust) {
                if (t.type === 'income') {
                    totalDebt += (t.bal || 0);
                } else if (t.type === 'debt') {
                    totalDebt -= (t.amount || 0); 
                }
            }
        });

        currentCustomerDebt = totalDebt;
        document.getElementById('currentDebtVal').innerText = totalDebt.toLocaleString() + " TZS";
        debtDisp.style.display = 'block';
        payDiv.classList.remove('hidden');
        amtInput.value = '';
        amtInput.readOnly = false;
        descInput.value = '';
    }

    function setDebtType(type) {
        const amtInput = document.getElementById('debtAmount');
        const descInput = document.getElementById('debtDesc');

        if (type === 'full') {
            const amount = currentCustomerDebt > 0 ? currentCustomerDebt : 0;
            amtInput.value = amount;
            amtInput.readOnly = true; 
            descInput.value = "Full Debt Clearance";
        } else {
            amtInput.value = '';
            amtInput.readOnly = false; 
            amtInput.focus();
            descInput.value = "Partial Payment";
        }
    }

    // --- CALCULATORS ---
    function calcBal() {
        const t = parseFloat(document.getElementById('opTotal').value) || 0;
        const p = parseFloat(document.getElementById('opPaid').value) || 0;
        document.getElementById('lblBal').innerText = (t - p).toLocaleString();
    }

    function calcFuelCost() {
        const liters = parseFloat(document.getElementById('opLiters').value) || 0;
        const cost = liters * FUEL_PRICE_TZ;
        document.getElementById('opExpAmount').value = cost;
    }

    function calcEstFuel() {
        const truckName = document.getElementById('opTruck').value;
        const distOneWay = parseFloat(document.getElementById('opDist').value) || 0;
        const type = document.getElementById('opTripType').value;
        const status = document.getElementById('opLoadStatus').value; 

        if(!truckName || distOneWay <= 0) {
            document.getElementById('estLiters').innerText = "0 Liters";
            document.getElementById('estCost').innerText = "0 TZS";
            document.getElementById('estInfo').innerText = "";
            return;
        }

        let truckModel = "";
        let truckObj = db.trucks.find(t => {
            const dispName = (typeof t === 'object') ? `${t.plate} (${t.model})` : t;
            return dispName === truckName;
        });

        if (truckObj && typeof truckObj === 'object') {
            truckModel = truckObj.model; 
        }

        let consumption = 0; 
        if (truckModel === 'Scania') consumption = (status === 'Loaded') ? 0.5 : 0.3;
        else if (truckModel === 'Fuso') consumption = (status === 'Loaded') ? 0.4 : 0.2;
        else consumption = (status === 'Loaded') ? 0.45 : 0.25;

        let totalDist = distOneWay; 
        let totalLiters = totalDist * consumption;
        let totalCost = totalLiters * FUEL_PRICE_TZ;

        document.getElementById('estLiters').innerText = totalLiters.toFixed(1) + " Liters";
        document.getElementById('estCost').innerText = totalCost.toLocaleString(undefined, {maximumFractionDigits:0}) + " TZS";
        document.getElementById('estInfo').innerText = `${truckModel} (${status}): ${consumption} L/km x ${totalDist}km`;
    }

    function checkDriverAvailability() {
        const driver = document.getElementById('opDriver').value;
        const mode = document.getElementById('opMode').value;
        if(mode !== 'income') return true;
        if(!driver) return true;

        const existingTrip = db.txs.find(t => 
            t.type === 'income' && 
            (typeof t.driver === 'object' ? t.driver.name : t.driver) === driver && 
            t.tripStatus !== 'Completed' 
        );

        if(existingTrip) {
            alert("‚ö†Ô∏è Driver is currently ON A TRIP! Please end their previous trip in 'History' or 'Recent Activity' before assigning a new one.");
            document.getElementById('opDriver').value = "";
            document.getElementById('opTruck').value = "";
            document.getElementById('opCustomer').value = "";
            return false;
        }
        return true;
    }

    function autoFillDriverDetails() {
        if(!checkDriverAvailability()) return;

        const name = document.getElementById('opDriver').value;
        const driver = db.drivers.find(d => (typeof d === 'object' ? d.name : d) === name);
        if(driver && typeof driver === 'object') {
            if(driver.customer) document.getElementById('opCustomer').value = driver.customer;
            if(driver.truck) {
                const truckSel = document.getElementById('opTruck');
                for (let i = 0; i < truckSel.options.length; i++) {
                    if (truckSel.options[i].text.includes(driver.truck)) {
                        truckSel.selectedIndex = i;
                        calcEstFuel(); 
                        break;
                    }
                }
            }
        }
    }

    // --- CORE LOGIC ---
    function save() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function saveOp() {
        if(!checkDriverAvailability()) return;

        const mode = document.getElementById('opMode').value;
        const date = document.getElementById('opDate').value;
        const truckRaw = document.getElementById('opTruck').value; 
        const driver = document.getElementById('opDriver').value;
        const desc = document.getElementById('opDesc').value;
        const method = document.getElementById('opMethod').value;
        const bank = method === 'Bank' ? document.getElementById('opBank').value : '';
        
        if((!truckRaw || !driver) || !date) { alert("Please fill required fields (Truck, Driver, Date)"); return; }

        let tx = { id: Date.now(), date, truck: truckRaw, driver, desc, method, bank, type: mode };

        if (mode === 'income') {
            tx.customer = document.getElementById('opCustomer').value;
            tx.dist = parseFloat(document.getElementById('opDist').value) || 0;
            tx.total = parseFloat(document.getElementById('opTotal').value) || 0;
            tx.paid = parseFloat(document.getElementById('opPaid').value) || 0;
            tx.bal = tx.total - tx.paid;
            
            tx.tripType = document.getElementById('opTripType').value;
            tx.status = document.getElementById('opLoadStatus').value;
            tx.cargo = document.getElementById('opCargoType').value || '-';
            tx.tripStatus = 'In Transit'; 

            // Handle Route
            if (tx.tripType === 'Round') {
                let stops = [];
                document.querySelectorAll('.route-region').forEach(sel => {
                    if(sel.value) stops.push(sel.value);
                });
                if(stops.length < 2) { alert("Round trip requires at least 2 stops/regions."); return; }
                
                tx.from = stops[0];
                tx.to = stops[stops.length-1];
                tx.routeFull = stops.join(" ‚ûù ");
                tx.routeStops = stops; // Save array for map plotting
            } else {
                tx.from = document.getElementById('opFrom').value;
                tx.to = document.getElementById('opTo').value;
                tx.routeFull = `${tx.from} ‚ûù ${tx.to}`;
                tx.routeStops = [tx.from, tx.to];
            }

            // UPDATE ODOMETER
            let truckIdx = db.trucks.findIndex(t => {
                const dispName = (typeof t === 'object') ? `${t.plate} (${t.model})` : t;
                return dispName === truckRaw;
            });

            if (truckIdx !== -1 && typeof db.trucks[truckIdx] === 'object') {
                db.trucks[truckIdx].odo = (db.trucks[truckIdx].odo || 0) + tx.dist;
            }

        } else if (mode === 'expense') {
            tx.cat = document.getElementById('opCat').value;
            tx.amount = parseFloat(document.getElementById('opExpAmount').value) || 0;
            if(tx.cat === 'Fuel') tx.liters = parseFloat(document.getElementById('opLiters').value) || 0;
        }

        db.txs.push(tx);
        save();
        alert("Saved!");
        
        // Clear inputs
        document.getElementById('opDesc').value = ''; 
        document.getElementById('opTotal').value = '';
        document.getElementById('opPaid').value = '';
        document.getElementById('opExpAmount').value = '';
        document.getElementById('opLiters').value = '';
        document.getElementById('opDist').value = '';
        document.getElementById('opCargoType').value = '';
        document.getElementById('estLiters').innerText = "0 Liters";
        document.getElementById('estCost').innerText = "0 TZS";
        
        // Reset Route Builder
        document.getElementById('routeRows').innerHTML = '';
        addRouteLeg(); addRouteLeg();
        
        renderAll();
        updateMap();
    }

    function endTrip(txId) {
        if(confirm("End this trip? This will free up the driver for a new assignment.")) {
            let txIndex = db.txs.findIndex(t => t.id === txId);
            if(txIndex !== -1) {
                db.txs[txIndex].tripStatus = 'Completed';
                save();
                renderAll();
                updateMap(); // remove line from map
                if(document.getElementById('history').classList.contains('active')) renderHistory();
                alert("Trip Completed! Driver is now available.");
            }
        }
    }

    function saveDebtTx() {
        const date = document.getElementById('debtDate').value;
        const customer = document.getElementById('debtCustomer').value;
        const amount = parseFloat(document.getElementById('debtAmount').value) || 0;
        const desc = document.getElementById('debtDesc').value;
        const method = document.getElementById('debtMethod').value;
        const bank = method === 'Bank' ? document.getElementById('debtBank').value : '';

        if(!date || !customer || amount <= 0) {
            alert("Please check Date, Customer and Amount.");
            return;
        }

        let tx = {
            id: Date.now(),
            date: date,
            type: 'debt',
            customer: customer,
            amount: amount,
            desc: desc,
            method: method,
            bank: bank,
            truck: 'N/A', 
            driver: ''
        };

        db.txs.push(tx);
        save();
        alert("Debt Payment Saved!");
        
        document.getElementById('debtAmount').value = '';
        document.getElementById('debtDesc').value = '';
        document.getElementById('debtDisplay').style.display = 'none';
        document.getElementById('paymentModeDiv').classList.add('hidden');
        renderAll();
    }

    function deleteTx(id) {
        if(confirm('Delete transaction?')) {
            db.txs = db.txs.filter(t => t.id !== id);
            save(); 
            renderAll();
            updateMap();
            if(document.getElementById('history').classList.contains('active')) renderHistory();
        }
    }

    function addCompliance() {
        const type = document.getElementById('cpType').value;
        const truck = document.getElementById('cpTruck').value;
        const date = document.getElementById('cpDate').value;
        const amount = document.getElementById('cpAmount').value;
        const ref = document.getElementById('cpRef').value;

        if(!truck || !date || !type) { alert("Please fill details"); return; }

        let isOneOff = type.includes("Fine") || type.includes("Penalty") || type.includes("Parking");

        db.compliance.push({
            id: Date.now(),
            type: type,
            truck: truck,
            date: date,
            amount: amount,
            ref: ref,
            status: isOneOff ? 'Paid' : 'Pending'
        });
        save();
        alert("Compliance Record Added!");
        renderAll();
    }

    function deleteComp(id) {
        if(confirm("Remove this record?")) {
            db.compliance = db.compliance.filter(c => c.id !== id);
            save(); renderAll();
        }
    }

    function resetService(plate) {
        if(confirm("Mark Service as Done for " + plate + "? This will reset the service counter.")) {
            let tIndex = db.trucks.findIndex(t => t.plate === plate);
            if(tIndex !== -1) {
                db.trucks[tIndex].lastServiceOdo = db.trucks[tIndex].odo;
                save();
                renderAll();
                alert("Service Reset Successful!");
            }
        }
    }
    
    function manualServiceReset() {
        const plate = document.getElementById('quickServiceTruck').value;
        if(!plate) { alert("Please select a truck first."); return; }
        resetService(plate);
    }

    // --- LEAFLET MAP LOGIC ---
    let map, routeLayerGroup;
    let activeRoutesMap = {}; // store bounds by tx id

    function initMap() {
        if(map) return;
        
        // Centered on Tanzania
        map = L.map('map').setView([-6.369, 34.888], 6);

        // OpenStreetMap Tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        routeLayerGroup = L.layerGroup().addTo(map);
        updateMap();
    }

    function updateMap() {
        if(!map) return;
        routeLayerGroup.clearLayers();
        
        const listDiv = document.getElementById('activeTrucksList');
        if(listDiv) listDiv.innerHTML = '';

        const colors = ['red', 'blue', 'green', 'purple', 'orange', 'darkblue'];
        let colorIdx = 0;
        let bounds = L.latLngBounds(); 
        let hasActiveRoutes = false;
        activeRoutesMap = {};

        // Custom Icons
        const startIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#16a34a; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 4px rgba(0,0,0,0.4);'></div>",
            iconSize: [16, 16]
        });

        const finishIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='font-size:16px;'>üèÅ</div>",
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        const truckIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#2563eb; width:24px; height:24px; border-radius:50%; border:2px solid white; box-shadow:0 0 5px rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; font-size:14px;'>üöö</div>",
            iconSize: [28, 28],
            iconAnchor: [14, 14]
        });

        db.txs.forEach(t => {
            // Check for active trip with valid route info
            if(t.type === 'income' && t.tripStatus === 'In Transit' && t.routeStops && t.routeStops.length >= 2) {
                let latlngs = [];
                t.routeStops.forEach(region => {
                    if(REGION_COORDS[region]) {
                        latlngs.push(REGION_COORDS[region]);
                    }
                });

                if(latlngs.length >= 2) {
                    hasActiveRoutes = true;
                    let routeColor = colors[colorIdx % colors.length];

                    // Draw Polyline
                    const polyline = L.polyline(latlngs, {
                        color: routeColor, 
                        weight: 4,
                        opacity: 0.8
                    }).addTo(routeLayerGroup);

                    // Add markers
                    latlngs.forEach(pt => bounds.extend(pt));
                    L.marker(latlngs[0], {icon: startIcon}).addTo(routeLayerGroup);
                    L.marker(latlngs[latlngs.length-1], {icon: finishIcon}).addTo(routeLayerGroup);

                    // Truck Icon at Midpoint
                    const middleIndex = Math.floor(latlngs.length / 2);
                    let markerPos = (latlngs.length === 2) ? 
                        [ (latlngs[0][0]+latlngs[1][0])/2, (latlngs[0][1]+latlngs[1][1])/2 ] : 
                        latlngs[middleIndex];

                    L.marker(markerPos, {icon: truckIcon})
                        .addTo(routeLayerGroup)
                        .bindPopup(`
                            <div style="font-family:sans-serif;">
                                <strong style="color:${routeColor}">${t.truck}</strong><br>
                                <small>Driver:</small> <b>${t.driver}</b><br>
                                <small>To:</small> ${t.to}<br>
                                <small>Cargo:</small> ${t.cargo}
                            </div>
                        `);

                    // Save bounds for this specific route for "Focus" feature
                    activeRoutesMap[t.id] = L.latLngBounds(latlngs);

                    // Add to Side List
                    if(listDiv) {
                        listDiv.innerHTML += `
                        <div class="map-item-card" style="border-left-color:${routeColor}" onclick="focusOnRoute(${t.id})">
                            <strong>${t.truck}</strong> <span style="font-size:0.7em; color:#64748b;">(${t.driver})</span><br>
                            ${t.from} ‚ûù ${t.to}
                        </div>`;
                    }

                    colorIdx++;
                }
            }
        });

        if(hasActiveRoutes) {
            map.fitBounds(bounds, {padding: [50, 50]});
        } else if (listDiv) {
            listDiv.innerHTML = '<p style="color:#94a3b8; font-size:0.8rem; text-align:center;">No active trips.</p>';
        }
    }

    function focusOnRoute(txId) {
        if(map && activeRoutesMap[txId]) {
            map.fitBounds(activeRoutesMap[txId], {padding: [50, 50]});
        }
    }

    // --- RENDERING ---
    function renderAll() {
        const truckOptions = db.trucks.map(t => typeof t === 'object' ? `${t.plate} (${t.model})` : t);
        const truckValues = db.trucks.map(t => typeof t === 'object' ? t.plate : t); 
        
        const fill = (id, list) => {
            const el = document.getElementById(id);
            if(!el) return;
            el.innerHTML = '<option value="">Select...</option>';
            list.forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
        };
        
        fill('opTruck', truckOptions); fill('cpTruck', truckOptions);
        fill('opCustomer', db.customers); 
        fill('debtCustomer', db.customers); 
        fill('opCat', db.categories);
        fill('newDriverCust', db.customers); 
        fill('newDriverTruck', truckValues); 
        fill('cpType', COMPLIANCE_TYPES_TZ); 
        fill('quickServiceTruck', truckValues); 

        const driverEl = document.getElementById('opDriver');
        driverEl.innerHTML = '<option value="">Select...</option>';
        db.drivers.forEach(d => {
            let name = typeof d === 'object' ? d.name : d;
            driverEl.innerHTML += `<option value="${name}">${name}</option>`;
        });

        const makeList = (id, list, type) => {
            const el = document.getElementById(id);
            if(!el) return;
            el.innerHTML = list.map((i,x) => {
                let disp = i;
                if(type === 'trucks' && typeof i === 'object') disp = `<b>${i.plate}</b> <small>${i.model}</small> <span class="tag">${i.trailers || 0} Trailers</span>`;
                if(type === 'drivers' && typeof i === 'object') {
                    const trkDisp = i.truck ? `<span style="background:#e0f2fe; color:#0284c7; padding:2px 5px; border-radius:4px; font-size:0.75rem;">${i.truck}</span>` : '<small style="color:#94a3b8">No Truck</small>';
                    disp = `<b>${i.name}</b><br><small>Cust: ${i.customer || '-'}</small> ${trkDisp}`;
                }
                
                return `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                    <span>${disp}</span> <span onclick="remReg('${type}',${x})" style="color:red; cursor:pointer;">√ó</span>
                </div>`;
            }).join('');
        };
        makeList('lst-trucks', db.trucks, 'trucks');
        makeList('lst-customers', db.customers, 'customers');
        makeList('lst-drivers', db.drivers, 'drivers');
        makeList('lst-categories', db.categories, 'categories');

        const listEl = document.getElementById('txList');
        listEl.innerHTML = '';
        
        let cash = 0, exp = 0, debtPaid = 0, pending = 0;
        let truckStats = {}; 
        let totalFuelLiters = 0;
        let totalFuelCost = 0;

        [...db.txs].reverse().forEach(t => {
            let row = '';
            let amountDisplay = '';
            let actionBtn = `<button onclick="deleteTx(${t.id})" style="color:#cbd5e1; border:none; background:none;">√ó</button>`;
            
            if(t.truck !== 'N/A') {
                if(!truckStats[t.truck]) truckStats[t.truck] = { liters: 0, km: 0, inc: 0, exp: 0, fuelCost: 0 };
                
                if(t.type === 'income') {
                    truckStats[t.truck].inc += t.total;
                    if(t.dist) truckStats[t.truck].km += t.dist;
                } 
                if(t.type === 'expense') {
                    truckStats[t.truck].exp += t.amount;
                    if(t.cat === 'Fuel') {
                        if(t.liters) {
                            truckStats[t.truck].liters += t.liters;
                            totalFuelLiters += t.liters;
                        }
                        truckStats[t.truck].fuelCost += t.amount;
                        totalFuelCost += t.amount;
                    }
                }
            }

            if (t.type === 'income') {
                cash += t.paid;
                pending += t.bal;
                amountDisplay = `<span class="text-success">+${t.paid.toLocaleString()}</span>`;
                if(t.bal > 0) amountDisplay += `<br><small style="color:orange">Bal: ${t.bal.toLocaleString()}</small>`;
                let bankTxt = t.bank ? `<br><small style="color:blue">üè¶ ${t.bank}</small>` : '';
                
                let tripInfo = "";
                if(t.routeFull) {
                    tripInfo = `<br><span class="tag" style="background:#f3f4f6; white-space:normal;">${t.routeFull}</span>`;
                } else if(t.from && t.to) {
                    tripInfo = `<br><span class="tag" style="background:#f3f4f6;">${t.from} ‚ûù ${t.to}</span>`;
                }
                
                let cargoTxt = t.cargo && t.cargo !== '-' ? ` / <span style="font-weight:bold; color:var(--text-dark)">üì¶ ${t.cargo}</span>` : '';

                // TRIP STATUS BADGE & BUTTON
                let statusBadge = "";
                if(t.tripStatus === 'Completed') {
                    statusBadge = `<br><span class="status-badge status-complete">‚úÖ Completed</span>`;
                } else {
                    statusBadge = `<br><span class="status-badge status-transit">üöö In Transit</span>`;
                    actionBtn = `<button class="btn-end-trip" onclick="endTrip(${t.id})">üèÅ End Trip</button> <button onclick="deleteTx(${t.id})" style="color:red; border:none; background:none; margin-left:10px;">√ó</button>`;
                }

                row = `<td><b>${t.date}</b><br>${t.truck}<br><small>üë§ ${t.driver}</small></td>
                        <td>${t.customer}${tripInfo}<br><small>${t.dist ? t.dist+'km' : ''} ${cargoTxt}</small>${bankTxt}${statusBadge}</td>
                        <td style="text-align:right">${amountDisplay}</td>`;

            } else if (t.type === 'expense') {
                exp += t.amount;
                let extra = t.cat === 'Fuel' && t.liters ? `<div class="fuel-badge">‚õΩ ${t.liters}L</div>` : '';
                amountDisplay = `<span class="text-danger">-${t.amount.toLocaleString()}</span>`;
                row = `<td><b>${t.date}</b><br>${t.truck}<br><small>üë§ ${t.driver}</small></td>
                        <td>${t.cat}<br><small>${t.desc}</small>${extra}</td>
                        <td style="text-align:right">${amountDisplay}</td>`;
            
            } else if (t.type === 'debt') {
                cash += t.amount;
                debtPaid += t.amount; 
                amountDisplay = `<span class="text-success">+${t.amount.toLocaleString()}</span>`;
                let bankTxt = t.bank ? `<br><small style="color:blue">üè¶ ${t.bank}</small>` : '';
                row = `<td><b>${t.date}</b><br><span class="tag">DEBT COL.</span></td>
                        <td>From: ${t.customer}${bankTxt}</td>
                        <td style="text-align:right">${amountDisplay}</td>`;
            }

            if (listEl.childElementCount < 20) {
                 listEl.innerHTML += `<table style="margin-bottom:10px;"><tr>
                    ${row}
                    <td style="width:20px; vertical-align:middle; text-align:center;">${actionBtn}</td>
                </tr></table>`;
            }
        });

        // Totals
        const totalPending = pending - debtPaid;
        const profit = cash - exp;
        
        document.getElementById('kpi-cash').innerText = cash.toLocaleString();
        document.getElementById('kpi-pending').innerText = totalPending.toLocaleString();
        document.getElementById('kpi-expense').innerText = exp.toLocaleString();
        document.getElementById('kpi-profit').innerText = profit.toLocaleString();

        // --- RENDER DASHBOARD FLEET PERFORMANCE & MAINTENANCE ---
        const fuelListEl = document.getElementById('fuelList');
        const maintAlertBox = document.getElementById('maint-alert-box');
        const maintList = document.getElementById('maint-list');
        
        fuelListEl.innerHTML = '';
        maintList.innerHTML = '';
        let hasMaintenanceAlert = false;

        // Loop through trucks in DB to get Maintenance Data
        db.trucks.forEach(tObj => {
            if(typeof tObj !== 'object') return; 
            
            const truckName = `${tObj.plate} (${tObj.model})`;
            const s = truckStats[truckName] || { liters: 0, km: 0, inc: 0, exp: 0 };
            const netProfit = s.inc - s.exp;
            
            // Maintenance Calc
            const currentOdo = tObj.odo || 0;
            const lastService = tObj.lastServiceOdo || 0;
            const interval = tObj.interval || 5000;
            
            const kmRun = currentOdo - lastService;
            const kmRemaining = interval - kmRun;
            const percent = Math.min(100, (kmRun / interval) * 100);
            
            let barColor = '#10b981'; // Green
            if(percent > 75) barColor = '#f59e0b'; // Yellow
            if(percent >= 100) barColor = '#ef4444'; // Red

            // Alert Logic
            if (kmRemaining <= 500) {
                hasMaintenanceAlert = true;
                const urgency = kmRemaining <= 0 ? "OVERDUE" : "DUE SOON";
                const color = kmRemaining <= 0 ? "red" : "orange";
                maintList.innerHTML += `
                <div class="maint-row">
                    <span><span style="color:${color}; font-weight:bold;">${urgency}:</span> ${truckName} (${kmRemaining}km left)</span>
                    <button class="btn-sm" style="background:${color}; color:white; border:none; border-radius:4px; cursor:pointer;" onclick="resetService('${tObj.plate}')">Mark Service Done</button>
                </div>`;
            }

            const kml = s.liters > 0 ? (s.km / s.liters).toFixed(2) : '-';
            const profitColor = netProfit >= 0 ? 'var(--primary)' : 'var(--danger)';
            
            fuelListEl.innerHTML += `<tr>
                <td><b>${tObj.plate}</b><br><small>${tObj.model}</small></td>
                <td style="font-weight:bold; color:${profitColor}">${netProfit.toLocaleString()}</td>
                <td>${kml}</td>
                <td style="width:30%;">
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#64748b;">
                        <span>${kmRun} km</span>
                        <span>${interval} km</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width:${percent}%; background:${barColor};"></div>
                    </div>
                </td>
                <td style="text-align:center;">
                    <button onclick="resetService('${tObj.plate}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem;" title="Reset Service">üîß</button>
                </td>
            </tr>`;
        });

        maintAlertBox.style.display = hasMaintenanceAlert ? 'block' : 'none';

        // --- RENDER FUEL ANALYTICS ---
        document.getElementById('total-fuel-liters').innerText = totalFuelLiters.toLocaleString() + " L";
        document.getElementById('total-fuel-cost').innerText = totalFuelCost.toLocaleString() + " TZS";

        const fuelAnalyticsList = document.getElementById('fuelAnalyticsList');
        if(fuelAnalyticsList) {
            fuelAnalyticsList.innerHTML = '';
            Object.keys(truckStats).forEach(truck => {
                const s = truckStats[truck];
                if(s.liters > 0 || s.fuelCost > 0) { 
                     const percent = totalFuelCost > 0 ? ((s.fuelCost / totalFuelCost) * 100).toFixed(1) : 0;
                     fuelAnalyticsList.innerHTML += `
                        <tr>
                            <td><b>${truck}</b></td>
                            <td>${s.liters.toLocaleString()} L</td>
                            <td>${s.fuelCost.toLocaleString()} TZS</td>
                            <td>
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <div style="flex:1; height:6px; background:#fed7aa; border-radius:3px; overflow:hidden;">
                                        <div style="height:100%; width:${percent}%; background:#ea580c;"></div>
                                    </div>
                                    <small>${percent}%</small>
                                </div>
                            </td>
                        </tr>
                      `;
                }
            });
            if(fuelAnalyticsList.innerHTML === '') {
                fuelAnalyticsList.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#94a3b8;">No fuel data available yet.</td></tr>';
            }
        }

        // --- RENDER COMPLIANCE ---
        const cpBody = document.querySelector('#cpTable tbody');
        if(cpBody && db.compliance) {
            cpBody.innerHTML = db.compliance.map(c => {
                let statusBadge = '';
                const today = new Date().toISOString().slice(0,10);
                
                if (c.status === 'Paid') {
                    statusBadge = '<span class="tag">PAID</span>';
                } else {
                    if (c.date < today) {
                        statusBadge = '<span class="tag expired">EXPIRED</span>';
                    } else {
                        statusBadge = '<span class="tag active">ACTIVE</span>';
                    }
                }

                return `<tr>
                    <td>${c.type}<br><small style="color:#64748b">Ref: ${c.ref||'-'}</small></td>
                    <td>${c.truck}</td>
                    <td>${c.date}</td>
                    <td>${statusBadge}</td>
                    <td><button onclick="deleteComp(${c.id})" style="color:red; background:none; border:none;">√ó</button></td>
                </tr>`
            }).join('');
        }
    }

    // --- HISTORY PAGE LOGIC ---
    function renderHistory() {
        const histDiv = document.getElementById('historyList');
        const search = document.getElementById('histSearch').value.toLowerCase();
        histDiv.innerHTML = '';

        const allTxs = [...db.txs].reverse();
        
        const filtered = allTxs.filter(t => {
            const txt = (t.driver + t.truck + t.customer + t.cat + t.desc).toLowerCase();
            return txt.includes(search);
        });

        if(filtered.length === 0) {
            histDiv.innerHTML = '<p style="text-align:center; color:#94a3b8; margin-top:30px;">No history records found.</p>';
            return;
        }

        filtered.forEach(t => {
            let cardClass = '';
            let title = '';
            let subtitle = '';
            let amt = '';
            let statusHtml = '';

            if (t.type === 'income') {
                cardClass = 'income';
                title = `TRIP: ${t.customer}`;
                
                let routeDisplay = t.routeFull ? `Route: ${t.routeFull}` : `Truck: ${t.truck}`;
                subtitle = `${routeDisplay} ‚Ä¢ Driver: ${t.driver}`;
                
                amt = `<span class="text-success">+${t.paid.toLocaleString()}</span>`;
                
                if(t.tripStatus === 'Completed') {
                    statusHtml = `<div class="h-status st-done">Done</div>`;
                } else {
                    statusHtml = `<div class="h-status st-transit">In Transit</div> <button class="btn-sm btn-primary" onclick="endTrip(${t.id})">End Trip</button>`;
                }

            } else if (t.type === 'expense') {
                cardClass = 'expense';
                title = `EXP: ${t.cat}`;
                subtitle = `${t.desc} ‚Ä¢ ${t.truck} (${t.driver})`;
                amt = `<span class="text-danger">-${t.amount.toLocaleString()}</span>`;
            } else if (t.type === 'debt') {
                cardClass = 'debt';
                title = `DEBT PAID: ${t.customer}`;
                subtitle = `${t.desc} ‚Ä¢ ${t.method}`;
                amt = `<span class="text-success">+${t.amount.toLocaleString()}</span>`;
            }

            histDiv.innerHTML += `
            <div class="history-card ${cardClass}">
                <div style="flex:1;">
                    <div class="h-date">${t.date}</div>
                    <div class="h-title">${title}</div>
                    <div class="h-sub">${subtitle}</div>
                    ${statusHtml}
                </div>
                <div style="text-align:right;">
                    <div class="h-amt">${amt}</div>
                    <button onclick="deleteTx(${t.id})" style="color:#cbd5e1; border:none; background:none; font-size:1.2rem; cursor:pointer;">√ó</button>
                </div>
            </div>`;
        });
    }

    // --- REGISTRY FUNCTIONS ---
    function addReg(type, id) {
        const val = document.getElementById(id).value;
        if(val) { db[type].push(val); save(); document.getElementById(id).value=''; renderAll(); }
    }
    
    function addTruck() {
        const plate = document.getElementById('newTruckPlate').value;
        const model = document.getElementById('newTruckModel').value;
        const trailers = document.getElementById('newTruckTrailers').value;
        const interval = parseInt(document.getElementById('newTruckInterval').value) || 5000;

        if(plate) {
            db.trucks.push({ 
                plate: plate, 
                model: model, 
                trailers: trailers,
                interval: interval,
                odo: 0,
                lastServiceOdo: 0
            });
            save();
            document.getElementById('newTruckPlate').value = '';
            document.getElementById('newTruckInterval').value = '';
            renderAll();
        }
    }

    function checkTruckAssignment(selectEl) {
        const plate = selectEl.value;
        const errEl = document.getElementById('truck-assign-error');
        
        if(!plate) {
            errEl.style.display = 'none';
            selectEl.style.borderColor = '#e2e8f0';
            return true;
        }

        const isAssigned = db.drivers.some(d => (typeof d === 'object' ? d.truck : '') === plate);

        if(isAssigned) {
            errEl.style.display = 'block';
            errEl.innerHTML = `‚ö†Ô∏è <b>${plate}</b> is already assigned to a driver!`;
            selectEl.style.borderColor = 'red';
            return false;
        } else {
            errEl.style.display = 'none';
            selectEl.style.borderColor = '#e2e8f0';
            return true;
        }
    }

    function addDriver() {
        const name = document.getElementById('newDriver').value;
        const cust = document.getElementById('newDriverCust').value;
        const truckSelect = document.getElementById('newDriverTruck');
        const truck = truckSelect.value;
        
        if(!name) return;

        if(truck && !checkTruckAssignment(truckSelect)) {
            alert("Cannot assign: Truck is already taken by another driver.");
            return;
        }

        db.drivers.push({ name: name, customer: cust, truck: truck });
        save();
        document.getElementById('newDriver').value = '';
        renderAll();
    }

    function remReg(type, idx) {
        if(confirm("Remove?")) { db[type].splice(idx,1); save(); renderAll(); }
    }

    // --- SETTINGS ---
    function backupData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const anchor = document.createElement('a');
        anchor.setAttribute("href", dataStr);
        anchor.setAttribute("download", "truck_backup_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(anchor); anchor.click(); anchor.remove();
    }

    function restoreData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                db = JSON.parse(e.target.result);
                save();
                alert("Data Restored Successfully!");
                location.reload();
            } catch(err) { alert("Invalid file"); }
        };
        reader.readAsText(file);
    }

    function wipeData() {
        if(confirm("CRITICAL WARNING: This will delete everything. Type 'YES' to confirm.")) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    }
    
    function exportData() {
        let csv = "Date,Type,Truck,Driver,Customer,From,To,Route,Dist,Cargo,Liters,Amount\n";
        db.txs.forEach(t => {
            let amt = t.type==='expense' ? t.amount : (t.type==='income' ? t.paid : t.amount);
            let bnk = t.bank || '-';
            let frm = t.from || '-';
            let to = t.to || '-';
            let rte = t.routeFull || '-';
            let crg = t.cargo || '-';
            csv += `${t.date},${t.type},${t.truck||'-'},${t.driver||'-'},${t.customer||t.cat},${frm},${to},"${rte}",${t.dist||0},${crg},${t.liters||0},${amt}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.hidden = true; a.href = url; a.download = 'truck_data.csv';
        document.body.appendChild(a); a.click(); a.remove();
    }

    // --- ANALYTICS ---
    let chartP = null, chartE = null;

    function renderCharts() {
        const ctxP = document.getElementById('chartProfit').getContext('2d');
        const ctxE = document.getElementById('chartExpense').getContext('2d');
        
        if(chartP) chartP.destroy();
        if(chartE) chartE.destroy();

        let incByMonth = {}, expByMonth = {}, catTotals = {};

        db.txs.forEach(t => {
            const m = t.date.substring(0, 7); 
            if(!incByMonth[m]) { incByMonth[m]=0; expByMonth[m]=0; }
            
            if(t.type === 'income') incByMonth[m] += t.total;
            if(t.type === 'expense') {
                expByMonth[m] += t.amount;
                catTotals[t.cat] = (catTotals[t.cat] || 0) + t.amount;
            }
        });

        const labels = Object.keys(incByMonth).sort();
        chartP = new Chart(ctxP, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: i18n[curLang].th_inc || "Income", data: labels.map(m => incByMonth[m]), backgroundColor: '#10b981' },
                    { label: i18n[curLang].th_exp || "Expense", data: labels.map(m => expByMonth[m]), backgroundColor: '#ef4444' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        chartE = new Chart(ctxE, {
            type: 'doughnut',
            data: {
                labels: Object.keys(catTotals),
                datasets: [{
                    data: Object.values(catTotals),
                    backgroundColor: ['#f59e0b', '#ef4444', '#3b82f6', '#6366f1', '#8b5cf6', '#10b981', '#64748b']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    init();
</script>
</body>
</html>
